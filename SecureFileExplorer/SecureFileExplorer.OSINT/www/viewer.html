<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; style-src 'unsafe-inline'; script-src 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; frame-src 'self';">
    <title>File Viewer - OSINT Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0b0f19;
            color: #eee;
        }

        .header {
            background: #111421;
            padding: 15px 20px;
            border-bottom: 2px solid #2a3040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .header h1 {
                color: #0af;
                font-size: 18px;
            }

            .header .actions {
                display: flex;
                gap: 10px;
            }

            .header button {
                padding: 8px 15px;
                background: #0af;
                color: #fff;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.3s;
            }

                .header button:hover {
                    background: #0099dd;
                }

        .content {
            padding: 20px;
            height: calc(100vh - 60px);
            overflow: auto;
        }

        pre {
            background: #111421;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .xml-viewer {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        .xml-tag {
            color: #e74c3c;
        }

        .xml-attr {
            color: #3498db;
        }

        .xml-value {
            color: #2ecc71;
        }

        .xml-text {
            color: #eee;
        }

        .zip-list {
            list-style: none;
        }

            .zip-list li {
                padding: 10px;
                border-bottom: 1px solid #2a3040;
                display: flex;
                justify-content: space-between;
                transition: background 0.2s;
            }

                .zip-list li:hover {
                    background: rgba(0, 170, 255, 0.1);
                }

        .csv-viewer {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

            .csv-viewer th {
                background: #1a1e2e;
                color: #0af;
                padding: 10px;
                text-align: left;
                border: 1px solid #2a3040;
                font-weight: 600;
            }

            .csv-viewer td {
                padding: 8px 10px;
                border: 1px solid #2a3040;
                color: #eee;
            }

            .csv-viewer tr:nth-child(even) {
                background: rgba(255, 255, 255, 0.02);
            }

            .csv-viewer tr:hover {
                background: rgba(0, 170, 255, 0.1);
            }

        .file-icon {
            margin-right: 10px;
        }

        .file-size {
            color: #888;
            font-size: 12px;
        }

        .error {
            color: #e74c3c;
            padding: 20px;
            text-align: center;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #0af;
            font-size: 18px;
        }

        .hex-viewer {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .hex-offset {
            color: #888;
            margin-right: 20px;
        }

        .hex-bytes {
            color: #0af;
            margin-right: 20px;
        }

        .hex-ascii {
            color: #2ecc71;
        }

        .json-viewer {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }

        .json-key {
            color: #3498db;
        }

        .json-string {
            color: #2ecc71;
        }

        .json-number {
            color: #f39c12;
        }

        .json-boolean {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 id="filename">Loading...</h1>
        <div class="actions">
            <button onclick="downloadFile()">📥 Download</button>
            <button onclick="copyToClipboard()">📋 Copy</button>
            <button onclick="window.close()">✖ Close</button>
        </div>
    </div>

    <div class="content" id="content">
        <div class="loading">Loading file...</div>
    </div>

    <script>
        // ============================================
        // SECURITY ENHANCEMENT: Input Sanitization
        // ============================================
        function sanitizeFilePath(path) {
            if (!path || typeof path !== 'string') {
                return null;
            }

            // Decode URL encoding first (to handle %20 for spaces, etc.)
            try {
                path = decodeURIComponent(path);
            } catch (e) {
                console.warn('Failed to decode path:', e);
                return null;
            }

            // Remove any null bytes
            path = path.replace(/\0/g, '');

            // Check for dangerous protocols
            if (/^(javascript|data|vbscript|file|about):/i.test(path)) {
                return null;
            }

            // Iteratively remove path traversal attempts
            let previous;
            do {
                previous = path;
                path = path.replace(/\.\./g, '');
            } while (path !== previous);

            // Remove any backslashes (normalize to forward slashes only)
            path = path.replace(/\\/g, '/');

            // Remove multiple consecutive slashes
            path = path.replace(/\/+/g, '/');

            // Remove leading slash to prevent absolute path access
            path = path.replace(/^\/+/, '');

            // Allow alphanumeric, spaces, common punctuation, accented characters, and path separators
            // This regex allows: letters (including accented), numbers, spaces, dash, underscore,
            // dot, forward slash, parentheses, brackets, apostrophe, and common accented characters
            if (!/^[a-zA-Z0-9\-_. \/\(\)\[\]'àâäéèêëïîôùûüÿçÀÂÄÉÈÊËÏÎÔÙÛÜŸÇ]+$/.test(path)) {
                return null;
            }

            // Additional check: ensure no '..' remains after all sanitization
            if (path.includes('..')) {
                return null;
            }

            return path;
        }

        function sanitizeFileName(name) {
            if (!name || typeof name !== 'string') {
                return 'Unknown';
            }

            // Iteratively remove HTML tags until no more tags exist
            // This prevents bypass attacks like <scr<script>ipt>
            let previous;
            do {
                previous = name;
                name = name.replace(/<[^>]*>/g, '');
            } while (name !== previous);

            // Iteratively remove dangerous characters
            do {
                previous = name;
                name = name.replace(/[<>"'&`=;()]/g, '');
            } while (name !== previous);

            // Remove any remaining control characters and null bytes
            name = name.replace(/[\x00-\x1F\x7F]/g, '');

            // Trim whitespace
            name = name.trim();

            // If empty after sanitization, return default
            if (name.length === 0) {
                return 'Unknown';
            }

            return name.substring(0, 255); // Limit length
        }

        /**
         * Escape HTML entities (already exists but enhanced)
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Safely create an attribute value (for src, href, etc.)
         * Uses iterative approach to prevent bypass attacks
         */
        function sanitizeAttribute(value) {
            if (!value || typeof value !== 'string') {
                return '';
            }

            // First escape HTML entities
            let sanitized = escapeHtml(value);

            // Iteratively remove quotes and dangerous characters
            let previous;
            do {
                previous = sanitized;
                sanitized = sanitized.replace(/["'`]/g, '');
            } while (sanitized !== previous);

            // Remove control characters and null bytes
            sanitized = sanitized.replace(/[\x00-\x1F\x7F]/g, '');

            // Remove any remaining angle brackets
            do {
                previous = sanitized;
                sanitized = sanitized.replace(/[<>]/g, '');
            } while (sanitized !== previous);

            return sanitized;
        }

        /**
         * Create element safely using DOM methods instead of innerHTML
         */
        function createSafeElement(tag, attributes = {}, textContent = '') {
            const element = document.createElement(tag);

            for (const [key, value] of Object.entries(attributes)) {
                if (key === 'textContent') {
                    element.textContent = value;
                } else if (key === 'innerHTML') {
                    // Only for pre-sanitized content
                    element.innerHTML = value;
                } else {
                    element.setAttribute(key, sanitizeAttribute(value));
                }
            }

            if (textContent) {
                element.textContent = textContent;
            }

            return element;
        }

        // ============================================
        // Initialize with sanitized parameters
        // ============================================

        const urlParams = new URLSearchParams(window.location.search);
        const rawFilePath = urlParams.get('file');
        const rawFileName = urlParams.get('name');

        const filePath = sanitizeFilePath(rawFilePath);
        const fileName = sanitizeFileName(rawFileName);

        const filenameElement = document.getElementById('filename');
        filenameElement.textContent = fileName;

        if (!filePath) {
            showError('Invalid or unsafe file path');
        }

        async function loadFile() {
            if (!filePath) {
                showError('No valid file specified');
                return;
            }

            try {
                const response = await fetch(`/files/${filePath}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('Content-Type');
                const ext = fileName.split('.').pop().toLowerCase();

                if (ext === 'docx' || ext === 'doc') {
                    const arrayBuffer = await response.arrayBuffer();
                    await displayDocx(arrayBuffer);
                } else if (ext === 'xlsx' || ext === 'xls') {
                    const arrayBuffer = await response.arrayBuffer();
                    await displayXlsx(arrayBuffer);
                } else if (ext === 'xml' || contentType.includes('xml')) {
                    const text = await response.text();
                    displayXML(text);
                } else if (ext === 'json' || contentType.includes('json')) {
                    const text = await response.text();
                    displayJSON(text);
                } else if (ext === 'csv' || contentType.includes('csv')) {
                    const text = await response.text();
                    displayCSV(text);
                } else if (ext === 'rtf' || contentType.includes('rtf')) {
                    const text = await response.text();
                    displayRTF(text);
                } else if (ext === 'pptx') {
                    await displayOfficeFile(ext, response);
                } else if (ext === 'ppt') {
                    displayLegacyOfficeInfo(ext);
                } else if (ext === 'pdf' || contentType.includes('pdf')) {
                    displayPDF(filePath);
                } else if (ext === 'zip' || ext === 'rar' || ext === '7z' || ext === 'tar' || ext === 'gz') {
                    displayArchiveInfo(ext);
                } else if (contentType.includes('text') ||
                    ext === 'txt' || ext === 'md' || ext === 'log' ||
                    ext === 'js' || ext === 'css' || ext === 'html' || ext === 'htm' ||
                    ext === 'yml' || ext === 'yaml' || ext === 'ini' || ext === 'cfg' ||
                    ext === 'sql' || ext === 'php' || ext === 'py' || ext === 'java' ||
                    ext === 'cpp' || ext === 'c' || ext === 'h' || ext === 'cs' ||
                    ext === 'sh' || ext === 'bat' || ext === 'ps1' || ext === 'vbs') {
                    const text = await response.text();
                    displayText(text, ext);
                } else if (contentType.includes('image')) {
                    displayImage(filePath, ext);
                } else if (ext === 'eml' || ext === 'msg') {
                    const text = await response.text();
                    displayEmail(text, ext);
                } else {
                    const arrayBuffer = await response.arrayBuffer();
                    displayHex(arrayBuffer);
                }
            } catch (error) {
                showError(`Error loading file: ${error.message}`);
            }
        }

        async function displayDocx(arrayBuffer) {
            try {
                const zip = await JSZip.loadAsync(arrayBuffer);
                const documentXml = await zip.file('word/document.xml').async('string');

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(documentXml, 'text/xml');

                const container = document.getElementById('content');
                container.innerHTML = '';

                const wrapper = document.createElement('div');
                wrapper.style.padding = '20px';

                const heading = document.createElement('h2');
                heading.style.cssText = 'color: #0af; margin-bottom: 20px;';
                heading.textContent = '📄 Word Document (DOCX)';

                const contentBox = document.createElement('div');
                contentBox.className = 'docx-content';

                const paragraphs = xmlDoc.getElementsByTagName('w:p');

                for (let i = 0; i < paragraphs.length; i++) {
                    const paragraph = paragraphs[i];
                    const texts = paragraph.getElementsByTagName('w:t');

                    let paragraphText = '';
                    for (let j = 0; j < texts.length; j++) {
                        paragraphText += texts[j].textContent;
                    }

                    if (paragraphText.trim()) {
                        const p = document.createElement('p');
                        p.textContent = paragraphText;
                        contentBox.appendChild(p);
                    } else {
                        contentBox.appendChild(document.createElement('br'));
                    }
                }

                if (contentBox.children.length === 0) {
                    contentBox.innerHTML = '<p style="color: #888; font-style: italic;">Document appears to be empty.</p>';
                }

                wrapper.appendChild(heading);
                wrapper.appendChild(contentBox);
                container.appendChild(wrapper);

            } catch (error) {
                console.error('DOCX parsing error:', error);
                showError(`Error parsing DOCX: ${error.message}`);
            }
        }

        async function displayXlsx(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const container = document.getElementById('content');
                container.innerHTML = '';

                const wrapper = document.createElement('div');
                wrapper.style.padding = '20px';

                const heading = document.createElement('h2');
                heading.style.cssText = 'color: #0af; margin-bottom: 20px;';
                heading.textContent = '📊 Excel Spreadsheet';
                wrapper.appendChild(heading);

                if (workbook.SheetNames.length > 1) {
                    const sheetSelector = document.createElement('div');
                    sheetSelector.className = 'sheet-selector';

                    workbook.SheetNames.forEach((sheetName, index) => {
                        const btn = document.createElement('button');
                        btn.className = index === 0 ? 'sheet-btn active' : 'sheet-btn';
                        btn.textContent = sheetName;

                        btn.onclick = function () {
                            document.querySelectorAll('.sheet-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            showSheet(workbook, sheetName);
                        };

                        sheetSelector.appendChild(btn);
                    });

                    wrapper.appendChild(sheetSelector);
                }

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-wrapper';
                tableWrapper.id = 'sheet-content';

                wrapper.appendChild(tableWrapper);
                container.appendChild(wrapper);

                showSheet(workbook, workbook.SheetNames[0]);

            } catch (error) {
                console.error('XLSX parsing error:', error);
                showError(`Error parsing Excel file: ${error.message}`);
            }
        }

        function showSheet(workbook, sheetName) {
            const sheet = workbook.Sheets[sheetName];
            const html = XLSX.utils.sheet_to_html(sheet);

            const tableWrapper = document.getElementById('sheet-content');
            tableWrapper.innerHTML = html;

            const table = tableWrapper.querySelector('table');
            if (table) {
                table.className = 'xlsx-viewer';
            }
        }

        function displayRTF(rtfText) {
            let plainText = rtfText;

            try {
                plainText = plainText
                    .replace(/\\[^{}]+/g, ' ')
                    .replace(/[{}]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (plainText.length < 50 && rtfText.length > 100) {
                    plainText = rtfText;
                }
            } catch (e) {
                console.warn('RTF parsing failed:', e);
            }

            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, '📝 RTF Document');

            const infoBox = createSafeElement('div', {
                style: 'margin-bottom: 20px; padding: 15px; background: #111421; border-radius: 8px;'
            });
            infoBox.innerHTML = '<strong style="color: #3498db;">ℹ️ Format:</strong><span style="color: #ccc;"> Rich Text Format (RTF)</span>';

            const extractedBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px; margin-bottom: 20px;'
            });

            const extractedHeading = createSafeElement('h3', {
                style: 'color: #eee; margin-bottom: 15px;'
            }, '📋 Extracted Text:');

            const extractedPre = createSafeElement('pre', {
                style: 'white-space: pre-wrap; word-wrap: break-word; font-family: monospace; background: #0b0f19; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;'
            }, plainText.substring(0, 10000) + (plainText.length > 10000 ? '\n... (content truncated)' : ''));

            extractedBox.appendChild(extractedHeading);
            extractedBox.appendChild(extractedPre);

            const rawBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px;'
            });

            const rawHeading = createSafeElement('h3', {
                style: 'color: #eee; margin-bottom: 15px;'
            }, '⚙️ Raw RTF (Preview):');

            const rawPre = createSafeElement('pre', {
                style: 'white-space: pre-wrap; word-wrap: break-word; font-family: monospace; background: #0b0f19; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-size: 12px; color: #888;'
            }, rtfText.substring(0, 2000) + (rtfText.length > 2000 ? '\n... (RTF truncated for preview)' : ''));

            rawBox.appendChild(rawHeading);
            rawBox.appendChild(rawPre);

            wrapper.appendChild(heading);
            wrapper.appendChild(infoBox);
            wrapper.appendChild(extractedBox);
            wrapper.appendChild(rawBox);

            container.appendChild(wrapper);
        }

        async function displayOfficeFile(ext, response) {
            try {
                const arrayBuffer = await response.arrayBuffer();

                const typeNames = {
                    'docx': 'Word Document',
                    'xlsx': 'Excel Spreadsheet',
                    'pptx': 'PowerPoint Presentation'
                };

                const container = document.getElementById('content');
                container.innerHTML = '';

                const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

                const heading = createSafeElement('h2', {
                    style: 'color: #0af; margin-bottom: 20px;'
                }, `📄 ${typeNames[ext]} (${ext.toUpperCase()})`);

                wrapper.appendChild(heading);

                const infoBox = createSafeElement('div', {
                    style: 'margin-bottom: 20px; padding: 15px; background: #111421; border-radius: 8px;'
                });
                infoBox.innerHTML = `<strong style="color: #3498db;">ℹ️ File Info:</strong><span style="color: #ccc;"> ${arrayBuffer.byteLength.toLocaleString()} bytes</span>`;
                wrapper.appendChild(infoBox);

                if (ext === 'docx') {
                    try {
                        const text = await extractTextFromDocx(arrayBuffer);
                        if (text && text.trim().length > 0) {
                            const textBox = createSafeElement('div', {
                                style: 'background: #111421; padding: 20px; border-radius: 8px; margin-bottom: 20px;'
                            });

                            const textHeading = createSafeElement('h3', {
                                style: 'color: #eee; margin-bottom: 15px;'
                            }, '📋 Extracted Text:');

                            const textPre = createSafeElement('pre', {
                                style: 'white-space: pre-wrap; word-wrap: break-word; font-family: monospace; background: #0b0f19; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;'
                            }, text.substring(0, 10000) + (text.length > 10000 ? '\n... (content truncated)' : ''));

                            textBox.appendChild(textHeading);
                            textBox.appendChild(textPre);
                            wrapper.appendChild(textBox);
                        }
                    } catch (e) {
                        console.warn('DOCX text extraction failed:', e);
                    }
                }

                const optionsBox = createSafeElement('div', {
                    style: 'background: #111421; padding: 20px; border-radius: 8px; margin-bottom: 20px;'
                });
                optionsBox.innerHTML = `
                                        <h3 style="color: #eee; margin-bottom: 15px;">🛠️ Options:</h3>
                                        <ul style="list-style: none; line-height: 2;">
                                            <li>📥 <strong>Download</strong> the file using the button above</li>
                                            <li>📂 <strong>Open with Microsoft Office</strong> or compatible software</li>
                                            <li>🌐 <strong>Upload to Google Docs/Sheets/Slides</strong> for online viewing</li>
                                            <li>🔍 <strong>Extract metadata</strong> using specialized tools</li>
                                        </ul>
                                    `;
                wrapper.appendChild(optionsBox);

                const tipBox = createSafeElement('div', {
                    style: 'margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; border-radius: 5px;'
                });
                tipBox.innerHTML = `
                                        <strong style="color: #3498db;">💡 OSINT Tip:</strong>
                                        <p style="color: #ccc; margin-top: 5px;">
                                            Office files contain metadata (author, dates, revisions) and potentially hidden data.
                                            Consider using specialized tools for thorough analysis.
                                        </p>
                                    `;
                wrapper.appendChild(tipBox);

                container.appendChild(wrapper);

            } catch (error) {
                showError(`Error processing Office file: ${error.message}`);
            }
        }

        async function extractTextFromDocx(arrayBuffer) {
            try {
                const bytes = new Uint8Array(arrayBuffer);
                let text = '';

                for (let i = 0; i < bytes.length; i++) {
                    if (bytes[i] >= 32 && bytes[i] <= 126) {
                        let word = '';
                        while (i < bytes.length && bytes[i] >= 32 && bytes[i] <= 126) {
                            word += String.fromCharCode(bytes[i]);
                            i++;
                        }
                        if (word.length > 3) {
                            text += word + ' ';
                        }
                    }
                }

                const decoder = new TextDecoder('utf-8');
                const fullText = decoder.decode(bytes);

                const xmlMatches = fullText.match(/<[^>]+>([^<]+)<\/[^>]+>/g);
                if (xmlMatches) {
                    xmlMatches.forEach(match => {
                        const textMatch = match.match(/<[^>]+>([^<]+)<\/[^>]+>/);
                        if (textMatch && textMatch[1].trim().length > 1) {
                            text += textMatch[1] + ' ';
                        }
                    });
                }

                return text.trim() || 'No extractable text found.';
            } catch (error) {
                console.warn('Text extraction failed:', error);
                return 'Unable to extract text from DOCX file.';
            }
        }

        function displayLegacyOfficeInfo(ext) {
            const typeNames = {
                'doc': 'Word Document (Legacy)',
                'xls': 'Excel Spreadsheet (Legacy)',
                'ppt': 'PowerPoint Presentation (Legacy)'
            };

            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, `📄 ${typeNames[ext]} (${ext.toUpperCase()})`);

            const description = createSafeElement('p', {
                style: 'color: #888; margin-bottom: 20px;'
            }, 'This is a legacy Microsoft Office binary file format.');

            const optionsBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px;'
            });
            optionsBox.innerHTML = `
                                    <h3 style="color: #eee; margin-bottom: 15px;">🛠️ Options:</h3>
                                    <ul style="list-style: none; line-height: 2;">
                                        <li>📥 <strong>Download</strong> the file using the button above</li>
                                        <li>🔄 <strong>Convert to modern format</strong> (.docx, .xlsx, .pptx) for better compatibility</li>
                                        <li>🔍 <strong>Use specialized tools</strong> for binary analysis</li>
                                    </ul>
                                `;

            wrapper.appendChild(heading);
            wrapper.appendChild(description);
            wrapper.appendChild(optionsBox);

            container.appendChild(wrapper);
        }

        function displayImage(imagePath, ext) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', {
                style: 'padding: 20px; text-align: center;'
            });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, `🖼️ Image (${escapeHtml(ext.toUpperCase())})`);

            const imageBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px; display: inline-block;'
            });

            const img = document.createElement('img');
            img.src = `/files/${sanitizeAttribute(imagePath)}`;
            img.alt = fileName;
            img.style.cssText = 'max-width: 100%; max-height: 70vh; border-radius: 5px;';

            const errorDiv = createSafeElement('div', {
                id: 'imageError',
                style: 'display: none; color: #e74c3c; padding: 20px;'
            }, 'Unable to display image. It may be corrupted or in an unsupported format.');

            img.onerror = function () {
                img.style.display = 'none';
                errorDiv.style.display = 'block';
            };

            imageBox.appendChild(img);
            imageBox.appendChild(errorDiv);

            const infoBox = createSafeElement('div', {
                style: 'margin-top: 20px; padding: 15px; background: #111421; border-radius: 8px; text-align: left; display: inline-block;'
            });

            const infoText = createSafeElement('p');
            const strongTag = createSafeElement('strong', {
                style: 'color: #0af;'
            }, 'ℹ️ Image loaded from: ');
            const codeTag = createSafeElement('code', {
                style: 'color: #ccc;'
            }, imagePath);

            infoText.appendChild(strongTag);
            infoText.appendChild(codeTag);
            infoBox.appendChild(infoText);

            wrapper.appendChild(heading);
            wrapper.appendChild(imageBox);
            wrapper.appendChild(infoBox);

            container.appendChild(wrapper);
        }

        function displayPDF(pdfPath) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, '📄 PDF Document');

            const pdfBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px; margin-bottom: 20px;'
            });

            const description = createSafeElement('p', {
                style: 'color: #ccc; margin-bottom: 15px;'
            }, 'PDF viewer requires browser support. If not displayed below, download and open with a PDF reader.');

            const iframe = document.createElement('iframe');
            iframe.src = `/files/${sanitizeAttribute(pdfPath)}`;
            iframe.style.cssText = 'width: 100%; height: 70vh; border: none; border-radius: 5px;';
            iframe.title = 'PDF Viewer';

            const note = createSafeElement('p', {
                style: 'color: #888; margin-top: 15px; font-size: 12px;'
            }, 'Note: Some PDFs may not display inline due to security restrictions.');

            pdfBox.appendChild(description);
            pdfBox.appendChild(iframe);
            pdfBox.appendChild(note);

            wrapper.appendChild(heading);
            wrapper.appendChild(pdfBox);

            container.appendChild(wrapper);
        }

        function displayEmail(emailText, ext) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, `📧 Email (${escapeHtml(ext.toUpperCase())})`);

            const emailBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px;'
            });

            const emailPre = createSafeElement('pre', {
                style: 'white-space: pre-wrap; word-wrap: break-word; font-family: monospace; max-height: 600px; overflow-y: auto;'
            }, emailText.substring(0, 5000) + (emailText.length > 5000 ? '\n... (email content truncated)' : ''));

            emailBox.appendChild(emailPre);

            const tipBox = createSafeElement('div', {
                style: 'margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; border-radius: 5px;'
            });
            tipBox.innerHTML = `
                                    <strong style="color: #3498db;">🔍 OSINT Analysis:</strong>
                                    <p style="color: #ccc; margin-top: 5px;">
                                        Check email headers for sender IP, routing information, and metadata.
                                        Look for embedded links and attachments.
                                    </p>
                                `;

            wrapper.appendChild(heading);
            wrapper.appendChild(emailBox);
            wrapper.appendChild(tipBox);

            container.appendChild(wrapper);
        }

        function displayXML(xmlText) {
            const highlighted = highlightXML(xmlText);
            const container = document.getElementById('content');
            container.innerHTML = '';

            const pre = createSafeElement('pre', {
                class: 'xml-viewer',
                innerHTML: highlighted
            });

            container.appendChild(pre);
        }

        function highlightXML(xml) {
            return escapeHtml(xml)
                .replace(/(&lt;\/?[\w-]+)/g, '<span class="xml-tag">$1</span>')
                .replace(/(&gt;)/g, '<span class="xml-tag">$1</span>')
                .replace(/([\w-]+)=/g, '<span class="xml-attr">$1</span>=')
                .replace(/="([^"]*)"/g, '=<span class="xml-value">"$1"</span>');
        }

        function displayJSON(jsonText) {
            try {
                const obj = JSON.parse(jsonText);
                const formatted = JSON.stringify(obj, null, 2);
                const highlighted = highlightJSON(formatted);

                const container = document.getElementById('content');
                container.innerHTML = '';

                const pre = createSafeElement('pre', {
                    class: 'json-viewer',
                    innerHTML: highlighted
                });

                container.appendChild(pre);
            } catch (e) {
                displayText(jsonText, 'txt');
            }
        }

        function highlightJSON(json) {
            return escapeHtml(json)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false|null)/g, ': <span class="json-boolean">$1</span>');
        }

        function displayText(text, ext) {
            let highlighted = escapeHtml(text);

            if (ext === 'html' || ext === 'htm') {
                highlighted = highlightHTML(text);
            } else if (ext === 'xml') {
                highlighted = highlightXML(text);
            } else if (ext === 'json') {
                try {
                    const obj = JSON.parse(text);
                    highlighted = highlightJSON(JSON.stringify(obj, null, 2));
                } catch (e) {
                    highlighted = escapeHtml(text);
                }
            } else if (ext === 'js') {
                highlighted = highlightJavaScript(text);
            } else if (ext === 'css') {
                highlighted = highlightCSS(text);
            }

            const lineCount = text.split('\n').length;
            const charCount = text.length;

            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, `📝 Text File (${escapeHtml(ext.toUpperCase())})`);

            const statsBox = createSafeElement('div', {
                style: 'margin-bottom: 20px; padding: 15px; background: #111421; border-radius: 8px; display: flex; gap: 20px;'
            });
            statsBox.innerHTML = `
                                    <div><strong style="color: #3498db;">📊 Lines:</strong> <span style="color: #ccc;">${lineCount}</span></div>
                                    <div><strong style="color: #3498db;">🔤 Characters:</strong> <span style="color: #ccc;">${charCount}</span></div>
                                    <div><strong style="color: #3498db;">💾 Size:</strong> <span style="color: #ccc;">${(text.length / 1024).toFixed(2)} KB</span></div>
                                `;

            const codeBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px;'
            });

            const codePre = createSafeElement('pre', {
                style: 'white-space: pre-wrap; word-wrap: break-word; font-family: "Consolas", "Monaco", monospace; max-height: 600px; overflow-y: auto; tab-size: 4;',
                innerHTML: highlighted
            });

            codeBox.appendChild(codePre);

            wrapper.appendChild(heading);
            wrapper.appendChild(statsBox);
            wrapper.appendChild(codeBox);

            container.appendChild(wrapper);
        }

        function highlightHTML(html) {
            return escapeHtml(html)
                .replace(/&lt;(\/?)(\w+)/g, '&lt;<span class="xml-tag">$1$2</span>')
                .replace(/&lt;\/\w+&gt;/g, '<span class="xml-tag">$&</span>')
                .replace(/(\w+)=/g, '<span class="xml-attr">$1</span>=')
                .replace(/="([^"]*)"/g, '=<span class="xml-value">"$1"</span>');
        }

        function highlightJavaScript(js) {
            return escapeHtml(js)
                .replace(/(\b(function|return|if|else|for|while|var|let|const|class|import|export|from|default)\b)/g, '<span style="color: #e74c3c;">$1</span>')
                .replace(/(\b(true|false|null|undefined)\b)/g, '<span style="color: #f39c12;">$1</span>')
                .replace(/(["'][^"']*["'])/g, '<span style="color: #2ecc71;">$1</span>')
                .replace(/(\/\/[^\n]*)/g, '<span style="color: #7f8c8d;">$1</span>');
        }

        function highlightCSS(css) {
            return escapeHtml(css)
                .replace(/([^{}]+){/g, '<span style="color: #3498db;">$1</span>{')
                .replace(/([a-zA-Z-]+):/g, '<span style="color: #9b59b6;">$1</span>:')
                .replace(/(#[0-9a-fA-F]{3,6})/g, '<span style="color: #2ecc71;">$1</span>')
                .replace(/(\b\d+[a-z]*\b)/g, '<span style="color: #f39c12;">$1</span>');
        }

        function displayCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) {
                displayText(csvText, 'txt');
                return;
            }

            const delimiter = csvText.includes(';') ? ';' : ',';
            const rows = lines.map(line => {
                const cells = [];
                let currentCell = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        cells.push(currentCell.trim());
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
                cells.push(currentCell.trim());
                return cells;
            });

            const headers = rows[0];
            const dataRows = rows.slice(1);

            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', {
                style: 'overflow-x: auto;'
            });

            const table = document.createElement('table');
            table.className = 'csv-viewer';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            dataRows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            wrapper.appendChild(table);

            const infoBox = createSafeElement('div', {
                style: 'margin-top: 20px; padding: 15px; background: #111421; border-radius: 8px; color: #888;'
            });
            infoBox.innerHTML = `<strong>ℹ️ CSV Info:</strong> ${dataRows.length} rows × ${headers.length} columns`;

            container.appendChild(wrapper);
            container.appendChild(infoBox);
        }

        function displayArchiveInfo(ext) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            const wrapper = createSafeElement('div', { style: 'padding: 20px;' });

            const heading = createSafeElement('h2', {
                style: 'color: #0af; margin-bottom: 20px;'
            }, `📦 Archive File (${escapeHtml(ext.toUpperCase())})`);

            const description = createSafeElement('p', {
                style: 'color: #888; margin-bottom: 20px;'
            }, 'This is an archive file. The browser cannot display its contents directly.');

            const optionsBox = createSafeElement('div', {
                style: 'background: #111421; padding: 20px; border-radius: 8px;'
            });
            optionsBox.innerHTML = `
                                    <h3 style="color: #eee; margin-bottom: 15px;">Options:</h3>
                                    <ul style="list-style: none; line-height: 2;">
                                        <li>📥 <strong>Download</strong> the file using the button above</li>
                                        <li>🗜️ <strong>Extract</strong> it using a tool like 7-Zip or WinRAR</li>
                                        <li>🔍 <strong>Analyze</strong> the contents for OSINT purposes</li>
                                    </ul>
                                `;

            const warningBox = createSafeElement('div', {
                style: 'margin-top: 20px; padding: 15px; background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; border-radius: 5px;'
            });
            warningBox.innerHTML = `
                                    <strong style="color: #e74c3c;">⚠️ Security Note:</strong>
                                    <p style="color: #ccc; margin-top: 5px;">
                                        Always scan archive files for malware before extracting them.
                                    </p>
                                `;

            wrapper.appendChild(heading);
            wrapper.appendChild(description);
            wrapper.appendChild(optionsBox);
            wrapper.appendChild(warningBox);

            container.appendChild(wrapper);
        }

        function displayHex(arrayBuffer) {
            const bytes = new Uint8Array(arrayBuffer);
            const maxBytes = Math.min(bytes.length, 4096);

            const container = document.getElementById('content');
            container.innerHTML = '';

            const pre = document.createElement('pre');
            pre.className = 'hex-viewer';

            for (let i = 0; i < maxBytes; i += 16) {
                const offset = i.toString(16).padStart(8, '0');
                const hexPart = [];
                const asciiPart = [];

                for (let j = 0; j < 16; j++) {
                    if (i + j < maxBytes) {
                        const byte = bytes[i + j];
                        hexPart.push(byte.toString(16).padStart(2, '0'));
                        asciiPart.push(byte >= 32 && byte <= 126 ? String.fromCharCode(byte) : '.');
                    } else {
                        hexPart.push('  ');
                        asciiPart.push(' ');
                    }
                }

                const lineDiv = document.createElement('div');

                const offsetSpan = createSafeElement('span', {
                    class: 'hex-offset'
                }, offset);

                const bytesSpan = createSafeElement('span', {
                    class: 'hex-bytes'
                }, hexPart.join(' '));

                const asciiSpan = createSafeElement('span', {
                    class: 'hex-ascii'
                }, asciiPart.join(''));

                lineDiv.appendChild(offsetSpan);
                lineDiv.appendChild(bytesSpan);
                lineDiv.appendChild(asciiSpan);

                pre.appendChild(lineDiv);
            }

            if (bytes.length > maxBytes) {
                const truncateDiv = createSafeElement('div', {
                    style: 'color: #888; margin-top: 20px;'
                }, `... (showing first ${maxBytes} bytes of ${bytes.length})`);
                pre.appendChild(truncateDiv);
            }

            container.appendChild(pre);
        }

        function showError(message) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            const errorDiv = createSafeElement('div', {
                class: 'error'
            }, `❌ ${message}`);

            container.appendChild(errorDiv);
        }

        async function downloadFile() {
            if (!filePath) {
                alert('Invalid file path');
                return;
            }

            const a = document.createElement('a');
            a.href = `/files/${sanitizeAttribute(filePath)}`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function copyToClipboard() {
            const contentElement = document.querySelector('#content pre');
            if (contentElement) {
                try {
                    await navigator.clipboard.writeText(contentElement.textContent);
                    alert('✅ Content copied to clipboard!');
                } catch (err) {
                    console.error('Copy failed:', err);
                    alert('❌ Failed to copy to clipboard');
                }
            } else {
                alert('❌ No content available to copy');
            }
        }

        loadFile();
    </script>
</body>

</html>